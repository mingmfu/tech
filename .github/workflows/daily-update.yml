name: Daily Content Update (Production)

on:
  schedule:
    # æ¯å¤© UTC 02:00 è¿è¡Œ (åŒ—äº¬æ—¶é—´ 10:00)
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install requests
    
    - name: Fetch real data from multiple sources
      run: |
        python3 scripts/fetch_real_data.py
    
    - name: Update index.html
      run: |
        python3 << 'EOF'
import json
import re
from datetime import datetime
from pathlib import Path

# è¯»å–è·å–çš„çœŸå®æ•°æ®
with open('daily_content.json', 'r', encoding='utf-8') as f:
    data = json.load(f)

news_list = data['news']
papers = data['papers']

# è¯»å–index.html
with open('index.html', 'r', encoding='utf-8') as f:
    html = f.read()

today = datetime.now()

# æ›´æ–°æ—¥æœŸ
html = re.sub(
    r'<span class="update-time">æœ€åæ›´æ–°: .*?</span>',
    f'<span class="update-time">æœ€åæ›´æ–°: {today.strftime("%Yå¹´%mæœˆ%dæ—¥")}</span>',
    html
)

html = re.sub(
    r'<span>æ¯æ—¥æ›´æ–° Â· .*?</span>',
    f'<span>æ¯æ—¥æ›´æ–° Â· {today.strftime("%Yå¹´%mæœˆ%dæ—¥")}</span>',
    html
)

# ä¿å­˜
with open('index.html', 'w', encoding='utf-8') as f:
    f.write(html)

print(f"âœ… å·²æ›´æ–°: {len(news_list)} æ¡æ–°é—», {len(papers)} ç¯‡è®ºæ–‡")
EOF
    
    - name: Commit and push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # æ·»åŠ æ•°æ®æ–‡ä»¶å’ŒHTML
        git add index.html daily_content.json
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --cached --quiet; then
          echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æ›´æ–°çš„å†…å®¹"
          exit 0
        fi
        
        git commit -m "ğŸ“° Daily update: $(date +'%Y-%m-%d')

Data sources:
- Hacker News (AI-related top stories)
- arXiv (cs.AI, cs.LG, cs.CL latest papers)
- GitHub (Trending AI/ML repositories)"
        
        git push
        
        echo "âœ… å·²æ¨é€æ›´æ–°"
    
    - name: Trigger GitHub Pages rebuild
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.repos.requestPagesBuild({
            owner: context.repo.owner,
            repo: context.repo.repo
          })
